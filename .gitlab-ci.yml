# -----------------------------------Set Up------------------------------------
variables:
    PYVERSION: 2
    TMPDIR: ./tmp
    ITK_DIR: /mnt/shared/mebner/environment/ITK/ITK_NiftyMIC-python${PYVERSION}-build/
    NIFTYREG_INSTALL: /mnt/shared/mebner/environment/NiftyReg/NiftyReg-master-install
    FSL_INSTALL: /mnt/shared/mebner/environment/FSL/fsl/
    CONVERT3D_INSTALL: /mnt/shared/mebner/environment/Convert3D/c3d-git-install

before_script:
    # add NiftyReg to path
    - export PATH="${NIFTYREG_INSTALL}/bin:$PATH"

    # add FSL
    - export PATH="${FSL_INSTALL}/bin:$PATH"

    # add Convert3D to path
    - export PATH="${CONVERT3D_INSTALL}/bin:$PATH"

    # save PySiTK folder path just in case
    - export pysitk_dir=$(pwd)

    # create a virtual env to dev-test
    - venv="pysitk-test-py${PYVERSION}"
    - mypython=$(which python${PYVERSION})
    - rm -rf $venv
    - virtualenv -p $mypython $venv
    - cd $venv
    - venv_dir=$(pwd)
    - source bin/activate
    
    # print Python version to CI output
    - which python
    - python --version

    # copy ITK_NiftyMIC-build WrapITK to site-packages of venv
    - itkpath=/mnt/shared/mebner/environment/ITK/ITK_NiftyMIC-python${PYVERSION}-build/Wrapping/Generators/Python/WrapITK.pth
    - pypath=${venv_dir}/lib/python*/site-packages
    - cp -v ${itkpath} ${pypath}

    # Set environment variables for NiftyMIC installation
    - export NIFTYMIC_ITK_DIR=$ITK_DIR

    # add CI_JOB_TOKEN for cloning dependent repositories in requirements.txt
    # (https://docs.gitlab.com/ee/user/project/new_ci_build_permissions_model.html#dependent-repositories)
    - cd $pysitk_dir
    - pwd
    - sed -i -- "s/cmiclab/gitlab-ci-token:${CI_JOB_TOKEN}@cmiclab/g" requirements.txt

    # install requirements
    - pip install -r requirements.txt
    - pip install -e .
    - pip list

after_script:
    # delete tmp-directory
    - rm -rfv ${TMPDIR}

# ----------------------------------Test Jobs----------------------------------
builddocs:
  # only:
  #   - master
  script:
    - cd doc
    - doxygen doxyfile
  tags:
    - gift-adelie

reconstruct_volume:
  # only:
  #   - master
  script:
    - python niftymic_reconstruct_volume.py --dir-input /home/mebner/data/FetalBrain/input_data --dir-output ${TMPDIR} --verbose 0
  tags:
    - gift-adelie

reconstruct_volume_from_slices:
  # only:
  #   - master
  script:    
    - python niftymic_reconstruct_volume_from_slices.py --dir-input /home/mebner/data/FetalBrain/motion_correction_oriented --reconstruction-space /home/mebner/data/FetalBrain/SRR_stacks3_TK1_lsmr_alpha0p03_itermax10_oriented.nii.gz --dir-output ${TMPDIR} --verbose 0
  tags:
    - gift-adelie  
